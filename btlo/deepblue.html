<!DOCTYPE html>
<html>
<title>Deep Blue</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../resources/css/index.css">
<link rel="stylesheet" href="../resources/css/layout.css">
<link rel="stylesheet" href="../resources/css/font-railway.css">
<link rel="stylesheet" href="../resources/css/font-console.css">
<link rel="stylesheet" href="../resources/css/room_layout.css">
	
<style>
	/* Hide scrollbar for Chrome, Safari and Opera */
	.hide::-webkit-scrollbar {
	    -webkit-appearance: none;
             width: 7px;
	}
	.hide::-webkit-scrollbar-thumb {
	  background-color: gray;    /* color of the scroll thumb */
	  border-radius: 7px;       /* roundness of the scroll thumb */
	  border: 3px solid gray;  /* creates padding around scroll thumb */
	}  
	/* Hide scrollbar for IE, Edge and Firefox */
	.hide {
	  scrollbar-width: thin;          /* "auto" or "thin" */
  	  scrollbar-color: gray;   /* scroll thumb and track */
	}
	span.p{
		padding: 0px;
	}
</style>
	
<!-- Topbar -->  
<body class="w3-light-grey w3-content hide" style="max-width:1920px">
	<div class="topnav">
	  <a href="../index" class="w3-bar-item w3-button w3-padding"><i class="fa fa-th-large fa-fw"></i>Home</a>
	  <a href="../thm" class="w3-bar-item w3-button w3-padding"><img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/images/THM.png" alt="THM" width="40px" height="20px"><i class="fa fa-th-large fa-fw"></i>Try Hack Me</a> 
	  <a href="../htb" class="w3-bar-item w3-button w3-padding"><img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/images/HTB.png" alt="HTB" width="20px" height="20px"><i class="fa fa-th-large fa-fw"></i>Hack The Box</a>
	  <a href="../btlo" class="w3-bar-item w3-button w3-padding"><img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/images/BTLO.png" alt="HTB" width="20px" height="20px"><i class="fa fa-th-large fa-fw"></i>Blue Teams Lab</a>
	</div>

<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:100px; margin-right:100px;">

	<!-- Header -->
	<header id="portfolio">
		<span class="w3-button w3-hide-large w3-xxlarge w3-hover-text-grey" onclick="w3_open()"><i class="fa fa-bars"></i></span>
		<div class="w3-container">
		<h1><b>Deep Blue</b></h1>
		</div>
	</header>
	
	<div class="w3-container w3-padding-large" style="margin-bottom:32px">
		<h4><u>URL:</u></h4>
			<p><a href="https://blueteamlabs.online/home/investigation/32" target="_blank" rel="noopener noreferrer">https://blueteamlabs.online/home/investigation/32</a></p>
			<br>
		<h4><u>Description:</u></h4> 
			<p>Deep Blue is an easy level defensive box that focuses on reading and extracting informtion from Event Viewer logs using a Third Party PowerShell script called 'DeepBlueCLI'<sub style="vertical-align: top;"><a href=#deepbluecli>[1]</a></sub> and filtering the logs accurately.</p>
			<br>
		<h4><u>Scenario:</u></h4>
			<p>A Windows workstation was recently compromised, and evidence suggests it was an attack against internet-facing RDP, then Meterpreter was deployed to conduct 'Actions on Objectives'. Can you verify these findings?
				<br>
			You have been provided with the Security.evtx and System.evtx log exports from the compromised system - you should analyze these, NOT the Windows logs generated by the lab machine (when using DeepBlueCLI ensure you're providing the path to these files, stored inside \Desktop\Investigation\.</p>
		<br>
		
      <h4><u>Q1. Using DeepBlueCLI, investigate the recovered Security log (Security.evtx). Which user account ran GoogleUpdate.exe?</u></h4>
		<p>Lets start with looking at what files are available for investigation:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/files.png" alt="files.png">
			<p>First thing we need to do is open the security.evtx file and review its contents. We can do this using DeepBlueCLI (as asked) to help automatically filter the log file for specific strings of interest. To do this we need to open PowerShell within the DeepBlueCLI folder. We can do this by holding "SHIFT" and Right Click then selecting  'Open PowerShell window here'. Once this has been done, we can type the following to get an overview of the Event Viewer log:</p>
			<span class="console">PS C:\Users\BTLOTest\Desktop\Investigation\DeepBlueCLI-master> .\DeepBlue.ps1 .\..\security.evtx</span>
		<p>Output:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/output.png" alt="output.png">
		<p>We can see the user Mike Smith was using GoogleUpdate.exe that had encoded Base64 into it. Lets decode this and look at what action was performed. We will use CyberChef to see the output:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/output_base64.png" alt="output_base64.png">
		<p> It appears an XML request was made. This doesn't appear to be suspicious to me, more just notifying the Google Update tool that it wants to download a new version to run. I could be wrong but I can't see anything more from it. Lets move onto the next question for further information.</p>
		<br>

      <h4><u>Q2. Using DeepBlueCLI investigate the recovered Security.evtx log. At what time is there likely evidence of Meterpreter activity?</u></h4>
		<p>Using the same technique from question 1 we can read through and find the log file required:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/meterpreter.png" alt="meterpreter.png">
		<p>We can see a meterpreter shell was in use at 10:48:14 AM on the 10th of April, 2021. But what is meterpreter<sub style="vertical-align: top;"><a href=#meterpreter>[2]</a></sub>? It is a tool used to help create stable reverse shells to a victims machine. In this case, it is being used to keep a steady shell between the attacker and Mike Smith's machine. We need to find out what program may have been used to leverage the shell in the first place, as I don't think it would of been a Google product, that is most likely being used to cover the real malicious program.</p>	
		<br>

      <h4><u>Q3. Using DeepBlueCLI investigate the recovered System.evtx log. What is the name of the suspicious service created?</u></h4>
		<p>Still continuing from the 2nd question, we can look through further to see what may have been created or modified by that reverse shell. In this case we want to identify a suspicious service that has been added to the system:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/rztbzn.png" alt="rztbzn.png">
		<p>It appears that potential program called 'rztbzn' has possible commands being pipped into a service from a 'Run On Command Prompt' terminal. This may be the service being used to report back potential commands back to the hackers machine? Lets keep looking.<p>
		<br>

      <h4><u>Q4. Investigate the Security.evtx log in Event Viewer. Process creation is being audited (event ID 4688). Identify the malicious executable downloaded that was used to gain a Meterpreter reverse shell, between 10:30 and 10:50 AM on the 10th of April 2021.</u></h4>
		<p>To answer this question we need to filter the current logs to the appropriate times. There is a lot of information, so filtering it will help narrow this down further. But why use this time frame? We can use the information we have gathered from the previous questions that a shell was created sometime before 10:48:14 AM, so we can assume that an executable may have been downloaded and run within this time frame. Lets start with filtering the logs down:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/filter_events.png" alt="filter_events.png">
		<p>With that completed, we can see all event logs between 10:30 AM and 10:50 AM on the specific day. Going through each individual log we are looking for Downloads, so for my first sweep I want to focus on anything within the 'Downloads' folder for the user. I can do this quickly using the 'Find...' function on the right hand pane. The results:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/malicious_software.png" alt="malicious_software.png">
		<p>Bingo. Looks like we can see Mike Smith downloaded a program called 'serviceupdate.exe'. This could be the questionable program. The most notable thing is that this program was downloaded roughly 2 minutes before the attack occurs. About 40 seconds after the download we can see some logon events, which could be the reverse shell connecting:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/logon.png" alt="logon.png">
		<br>

      <h4><u>Q5. It's also believed that an additional account was created to ensure persistence between 11:25 AM and 11:40 AM on the 10th April 2021. What was the command line used to create this account?</u></h4>
		<p>Persistence is the key to controlling the machine. Using the same filtering performed in the previous question we can narrow this down and look for user account creations with the 'Find...' feature again. We have found our first potential user account:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/Jack_wills(The_decoy).png" alt="jack_wills.png">
		<p>Looking through, it appears the hacker may not be comfortable with Windows, as they are trying to privlege escalate but can't seem to get the command correct for it. Maybe this isn't the user account in question. Lets look for the next account creation:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/service_act.png" alt="service_act.png">
		<p>Lets verify this by seeing if they were able to privlege escalate this account correctly:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/persistence.png" alt="persistence.png">
		<p>We can also verify by the next entry they were able to add this user account to accept RDP and then login with this account.</p>
	<br>

      <h4><u>Q6. What two local groups was this new account added to?</u></h4>
		<p>We know the first group this was added. We just need to roll back 1 or 2 events and we should see the other local group, otherwise we can search for the command <span class="console">net localgroup</span> with the 'Find...' and we should see it easily:</p>
		<img src="https://raw.githubusercontent.com/Damo004/cybersecurity-blog/main/resources/.images/DeepBlue/admin.png" alt="admin.png">
	<br>
      
		<h4><u>Resources:</u></h4>
			<p>[1]<a href="https://github.com/sans-blue-team/DeepBlueCLI" target="_blank" rel="noopener noreferrer" id="deepbluecli">https://github.com/sans-blue-team/DeepBlueCLI</a><br>
			[2]<a href="https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/" target="_blank" rel="noopener noreferrer" id="meterpreter">https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/</a></p>
			<br>
		
		<h4><u>Analysis:</u></h4>
		<p>It appears that employee Mike Smith may have accidentally downloaded a malicious software, serviceupdate.exe, without realising this. Once Mike was able to run this program with admin access, the software was then able to leverage a reverse shell by adding a custom service being named 'rztbzn'. Once the shell was established as 10:48:14 AM on April the 10th 2021, the attacker was able to create a new account, ServiceAct, trying to hide it as a regular service account for the machine. Once this account was created the user was able to privilege escalate this account to join the local groups Administrators and Remote Desktop Protocol. This has allowed for the attacker to have a backdoor into the device without appearing to have compromised the machine in doing so, effectivley killing the requirement of a backdoor and potentially bypassing any event triggers that may be in place within the company.<p>
		<p>I believe the first thing to be performed on this device is locking down the machine to an offline presence only, removing the malicious software serviceupdate.exe. Then we need to remove all Google software to ensure it is not still hidden within that service. Removal of the service 'rztbzn' is next followed by deletion of both user accounts 'Jack Wills' and 'ServiceAct'.</p>
		<p>Or you could wipe the machine and restore a backup if it is available.</p>
		<p>To prevent this from reoccuring admin access will need to be removed from Mike Smith to ensure that anything downloaded and ran that required admin access will need to be performed via the IT team. This could help mitigate any chance for this breach occuring again.</p>
		<br>
		
		<h4><u>Conclusion:</u></h4>
			<p>This is a great beginner level room to introduce the user into reviewing and extracting necessary information from Event Viewer logs. It also helps introduce Third Party scripts to simplify this further. The skills learnt from this room can also be carried across to other IT roles for day to day use in truobleshooting and information gathering. Thank you for spending the time reading through my walkthrough.</p>
			<br>
			<br>
		<iframe src="https://blueteamlabs.online/achievement/share/12036/32" title="Completed"></iframe>
		<br>
		<br>
	</div>

<!-- End page content -->
</div>
	
  <!-- Footer -->
  <footer id="footer" class="w3-dark-grey">
    <div class="w3-row-padding">
      <p  style="text-align: center;"><a href="../index">Author: Damian Gale</a> | <a href="../thm">Try Hack Me</a> | <a href="../htb">Hack The Box</a> | <a href="../btlo">Blue Team Labs</a></p>
  
    </div>
  </footer>
	
</body>
</html>

